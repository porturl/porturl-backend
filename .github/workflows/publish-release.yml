name: Publish Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'The tag to build (e.g. v1.0.0)'
        required: true
      sha:
        description: 'The commit SHA to build'
        required: false

permissions:
  id-token: write
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    outputs:
      jar-name: ${{ steps.build_info.outputs.JAR_NAME }}
      native-name: ${{ steps.build_info.outputs.NATIVE_NAME }}
      version: ${{ steps.release_info.outputs.version }}
      tag: ${{ steps.release_info.outputs.tag }}
      timestamp: ${{ steps.build_info.outputs.timestamp }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.sha || inputs.tag || github.event.release.tag_name }}

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '25'
          distribution: 'graalvm-community'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Get release info
        id: release_info
        run: |
          tag="${{ inputs.tag || github.event.release.tag_name }}"
          version="${tag#v}"
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Release tag: $tag"
          echo "Version: $version"

      # This step installs the C compiler toolchain, which is required
      # by GraalVM to build a fully static native executable.
      - name: Install toolchain for static linking and dependencies
        run: sudo apt-get update && sudo apt-get install -y zlib1g-dev

      - name: Build release artifacts (JAR and Native)
        env:
          IS_RELEASE_BUILD: "true"
        run: |
          ./gradlew clean bootJar nativeCompile writeArtifactInfo -x test

      - name: Prepare build information
        id: build_info
        run: |
          # Load variables from file into the shell environment
          source build/artifact-info.properties

          cat build/artifact-info.properties >> $GITHUB_OUTPUT

          version="${{ steps.release_info.outputs.version }}"
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT

          echo "Built JAR: $JAR_NAME"
          echo "Built Native: $NATIVE_NAME"
          echo "Version: $version"

      - name: Update Release with Artifacts and Docker Info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.release_info.outputs.tag }}
          VERSION: ${{ steps.release_info.outputs.version }}
        run: |
          # Fetch existing body
          EXISTING_BODY=$(gh release view "$TAG" --json body --template '{{.body}}')
          
          # Create new body with Custom Header + Existing Body + Docker info
          NEW_BODY=$(cat <<EOF
          ## ðŸš€ Release $TAG

          **Version:** $VERSION
          **Built:** ${{ steps.build_info.outputs.timestamp }}

          ### ðŸ“¦ Available Downloads
          - **JAR (JVM)**: \`${{ steps.build_info.outputs.JAR_NAME }}\`
          - **Native Executable**: \`${{ steps.build_info.outputs.NATIVE_NAME }}\`

          $EXISTING_BODY

          ---
          ### ðŸ³ Docker Images
          \`\`\`bash
          docker pull friesoft/porturl-backend:$VERSION
          \`\`\`
          EOF
          )
          
          # Update release notes and upload artifacts
          gh release edit "$TAG" --notes "$NEW_BODY"
          gh release upload "$TAG" \
            "build/libs/${{ steps.build_info.outputs.JAR_NAME }}" \
            "build/native/nativeCompile/${{ steps.build_info.outputs.NATIVE_NAME }}" \
            --clobber

      - name: Upload Artifacts for Docker Job
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: |
            build/libs/${{ steps.build_info.outputs.JAR_NAME }}
            build/native/nativeCompile/${{ steps.build_info.outputs.NATIVE_NAME }}
          retention-days: 1

  docker:
    runs-on: ubuntu-latest
    needs: build-and-publish

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.sha || inputs.tag || needs.build-and-publish.outputs.tag }}

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts
          path: artifacts

      - name: Restore Artifact Structure
        run: |
          mkdir -p build/libs
          mkdir -p build/native/nativeCompile
          cp artifacts/libs/* build/libs/
          cp artifacts/native/nativeCompile/* build/native/nativeCompile/
          chmod +x build/native/nativeCompile/*

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare Docker tags
        id: docker_tags
        run: |
          VERSION="${{ needs.build-and-publish.outputs.version }}"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"

          TAGS_NATIVE="friesoft/porturl-backend:$VERSION-native"
          TAGS_JVM="friesoft/porturl-backend:$VERSION,friesoft/porturl-backend:$VERSION-jvm"

          if [ "$IS_PRERELEASE" != "true" ]; then
            TAGS_JVM="$TAGS_JVM,friesoft/porturl-backend:latest"
            MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)
            TAGS_JVM="$TAGS_JVM,friesoft/porturl-backend:$MAJOR_MINOR"
          fi

          echo "tags_native=$TAGS_NATIVE" >> $GITHUB_OUTPUT
          echo "tags_jvm=$TAGS_JVM" >> $GITHUB_OUTPUT

      - name: Build and push Docker images (Native)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.native
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.docker_tags.outputs.tags_native }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=porturl-backend-native
            org.opencontainers.image.version=${{ needs.build-and-publish.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.created=${{ needs.build-and-publish.outputs.timestamp }}

      - name: Build and push Docker images (JVM)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.docker_tags.outputs.tags_jvm }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.version=${{ needs.build-and-publish.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.created=${{ needs.build-and-publish.outputs.timestamp }}

  finalize-release:
    runs-on: ubuntu-latest
    needs: [build-and-publish, docker]
    steps:
      - name: Publish Release (Undraft)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.build-and-publish.outputs.tag }}
        run: |
          gh release edit "$TAG" --draft=false --repo ${{ github.repository }}

      - name: Label PR as Published
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ inputs.sha || github.sha }}
        run: |
          PR_NUMBER=$(gh search prs "$COMMIT_SHA" --repo ${{ github.repository }} --merged --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh label create "autorelease: published" --repo ${{ github.repository }} --color "2cbe4e" --description "Release has been published" || true
            gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "autorelease: published"
          fi